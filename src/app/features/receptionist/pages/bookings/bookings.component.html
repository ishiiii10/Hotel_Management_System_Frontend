<div class="dashboard-container">
  <app-receptionist-sidebar></app-receptionist-sidebar>

  <main class="main-content">
    <header class="page-header">
      <h1 class="page-title">Bookings Management</h1>
      <div class="header-actions">
        <button class="btn-primary" (click)="openWalkInModal()">+ Create Walk-in Booking</button>
      </div>
    </header>

    <div class="filters-section">
      <div class="filters-title">Search & Filter</div>
      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label">Booking ID</label>
          <input type="number" class="filter-input" [(ngModel)]="searchBookingId" placeholder="Enter booking ID">
        </div>
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-input" [(ngModel)]="searchStatus">
            <option value="">All Status</option>
            <option *ngFor="let status of statuses" [value]="status">{{status}}</option>
          </select>
        </div>
        <div class="filter-actions">
          <button class="btn-primary" (click)="onSearch()">Search</button>
          <button class="btn-secondary" (click)="onReset()">Reset</button>
        </div>
      </div>
    </div>

    <div class="bookings-section">
      <div class="section-header">All Bookings</div>
      <div *ngIf="isLoading" class="loading-message">Loading bookings...</div>
      <table class="bookings-table" *ngIf="!isLoading">
        <thead>
          <tr>
            <th>ID</th>
            <th>Room</th>
            <th>Guest Name</th>
            <th>Check In</th>
            <th>Check Out</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let booking of filteredBookings">
            <td>{{booking.id}}</td>
            <td>{{booking.roomNumber || booking.roomId}}</td>
            <td>{{booking.guestName || '-'}}</td>
            <td>{{booking.checkInDate}}</td>
            <td>{{booking.checkOutDate}}</td>
            <td>{{formatCurrency(booking.totalAmount)}}</td>
            <td>{{booking.status}}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-action" (click)="openDetailsModal(booking)">View</button>
                <button class="btn-action btn-pay-bill" *ngIf="canPayBill(booking)" (click)="openBillModal(booking.id)">Pay Bill</button>
                <button class="btn-action btn-view-bill" *ngIf="hasBill(booking) && !canPayBill(booking)" (click)="openBillModal(booking.id)">View Bill</button>
                <button class="btn-action" *ngIf="canCheckIn(booking)" (click)="openCheckInModal(booking)">Check-in</button>
                <button class="btn-action" *ngIf="canCheckOut(booking)" (click)="openCheckOutModal(booking)">Check-out</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredBookings.length === 0">
            <td colspan="8" class="no-data">No bookings found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<div class="modal-overlay" *ngIf="showWalkInModal" (click)="closeWalkInModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Create Walk-in Booking</h2>
      <button class="close-button" (click)="closeWalkInModal()">X</button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="section-title-small">Search Availability</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Check-in Date *</label>
            <input type="date" class="form-input" [(ngModel)]="searchCheckIn" [min]="minDate">
          </div>
          <div class="form-group">
            <label class="form-label">Check-out Date *</label>
            <input type="date" class="form-input" [(ngModel)]="searchCheckOut" [min]="minSearchCheckOutDate">
          </div>
          <div class="form-group">
            <label class="form-label">&nbsp;</label>
            <button class="btn-primary" (click)="searchAvailableRooms()" [disabled]="checkingAvailability">
              {{ checkingAvailability ? 'Searching...' : 'Search Rooms' }}
            </button>
          </div>
        </div>
      </div>

      <div class="form-section" *ngIf="availableRooms.length > 0">
        <div class="section-title-small">Select Room</div>
        <div class="rooms-list">
          <div class="room-option" 
               *ngFor="let room of availableRooms"
               [class.selected]="walkInForm.roomId === room.id"
               (click)="walkInForm.roomId = room.id">
            <div class="room-info">
              <div class="room-number">{{ room.roomNumber }}</div>
              <div class="room-type">{{ room.roomType }}</div>
              <div class="room-price">{{ formatCurrency(room.pricePerNight) }}/night</div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title-small">Guest Information</div>
        <div class="form-group">
          <label class="form-label">Guest Name *</label>
          <input type="text" class="form-input" [(ngModel)]="walkInForm.guestName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Guest Email *</label>
          <input type="email" class="form-input" [(ngModel)]="walkInForm.guestEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">Guest Phone</label>
          <input type="text" class="form-input" [(ngModel)]="walkInForm.guestPhone">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Number of Guests *</label>
            <input type="number" class="form-input" [(ngModel)]="walkInForm.numberOfGuests" min="1" required>
          </div>
          <div class="form-group">
            <label class="form-label">Check-in Date *</label>
            <input type="date" class="form-input" [(ngModel)]="walkInForm.checkInDate" [min]="minDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Check-out Date *</label>
            <input type="date" class="form-input" [(ngModel)]="walkInForm.checkOutDate" [min]="minCheckOutDate" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Special Requests</label>
          <textarea class="form-input" [(ngModel)]="walkInForm.specialRequests" rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeWalkInModal()">Cancel</button>
        <button type="button" class="btn-primary" (click)="onCreateWalkInBooking()">Create Booking</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Booking Details #{{selectedBooking?.id}}</h2>
      <button class="close-button" (click)="closeDetailsModal()">X</button>
    </div>
    <div class="modal-body" *ngIf="selectedBooking">
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Booking ID</div>
          <div class="detail-value">{{selectedBooking.id}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Room</div>
          <div class="detail-value">{{selectedBooking.roomNumber || selectedBooking.roomId}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Guest Name</div>
          <div class="detail-value">{{selectedBooking.guestName || '-'}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Guest Email</div>
          <div class="detail-value">{{selectedBooking.guestEmail || '-'}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Guest Phone</div>
          <div class="detail-value">{{selectedBooking.guestPhone || '-'}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Check In</div>
          <div class="detail-value">{{selectedBooking.checkInDate}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Check Out</div>
          <div class="detail-value">{{selectedBooking.checkOutDate}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value">{{selectedBooking.status}}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Total Amount</div>
          <div class="detail-value">{{formatCurrency(selectedBooking.totalAmount)}}</div>
        </div>
        <div class="detail-item" *ngIf="selectedBooking.numberOfGuests">
          <div class="detail-label">Number of Guests</div>
          <div class="detail-value">{{selectedBooking.numberOfGuests}}</div>
        </div>
        <div class="detail-item" *ngIf="selectedBooking.specialRequests">
          <div class="detail-label">Special Requests</div>
          <div class="detail-value">{{selectedBooking.specialRequests}}</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeDetailsModal()">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showCheckInModal" (click)="closeCheckInModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Check-In Guest</h2>
      <button class="close-button" (click)="closeCheckInModal()">X</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Notes (Optional)</label>
        <textarea class="form-input" [(ngModel)]="checkInNotes" rows="3" placeholder="Enter check-in notes"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeCheckInModal()">Cancel</button>
        <button type="button" class="btn-primary" (click)="onCheckIn()">Check-In</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showCheckOutModal" (click)="closeCheckOutModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Check-Out Guest</h2>
      <button class="close-button" (click)="closeCheckOutModal()">X</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Notes (Optional)</label>
        <textarea class="form-input" [(ngModel)]="checkOutNotes" rows="2" placeholder="Enter check-out notes"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Rating (Optional)</label>
        <input type="number" class="form-input" [(ngModel)]="checkOutRating" min="1" max="5" placeholder="1-5">
      </div>
      <div class="form-group">
        <label class="form-label">Feedback (Optional)</label>
        <textarea class="form-input" [(ngModel)]="checkOutFeedback" rows="3" placeholder="Enter feedback"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" [(ngModel)]="checkOutLate"> Late Check-out
        </label>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeCheckOutModal()">Cancel</button>
        <button type="button" class="btn-primary" (click)="onCheckOut()">Check-Out</button>
      </div>
    </div>
  </div>
</div>

<!-- Bill Modal for Walk-in Bookings -->
<div class="modal-overlay" *ngIf="showBillModal" (click)="closeBillModal()">
  <div class="modal-content bill-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Bill Payment</h2>
      <button class="close-button" (click)="closeBillModal()">X</button>
    </div>
    <div class="modal-body">
      <div *ngIf="isLoadingBill" class="loading-message">Loading bill...</div>
      <div *ngIf="!isLoadingBill && bill" class="bill-details">
        <div class="bill-header">
          <div class="bill-number">Bill #{{ bill.billNumber }}</div>
          <div class="bill-status" [class.pending]="bill.status === 'PENDING'" [class.paid]="bill.status === 'PAID'">
            {{ bill.status }}
          </div>
        </div>
        
        <div class="bill-info">
          <div class="info-row">
            <span class="info-label">Booking ID:</span>
            <span class="info-value">{{ bill.bookingId }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Total Amount:</span>
            <span class="info-value">{{ formatCurrency(bill.totalAmount) }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Generated At:</span>
            <span class="info-value">{{ bill.generatedAt | date:'medium' }}</span>
          </div>
          <div class="info-row" *ngIf="bill.paidAt">
            <span class="info-label">Paid At:</span>
            <span class="info-value">{{ bill.paidAt | date:'medium' }}</span>
          </div>
        </div>

        <div *ngIf="bill.status === 'PENDING'" class="payment-section">
          <h3>Mark as Paid</h3>
          <p class="info-message">After marking this bill as paid, the booking will be automatically confirmed and can be checked in.</p>
          <form (ngSubmit)="onMarkBillAsPaid()">
            <div class="form-group">
              <label class="form-label">Payment Method *</label>
              <select class="form-input" [(ngModel)]="paymentForm.paymentMethod" name="paymentMethod" required>
                <option value="">Select payment method</option>
                <option value="CASH">Cash</option>
                <option value="CARD">Card</option>
                <option value="UPI">UPI</option>
                <option value="NET_BANKING">Net Banking</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Transaction ID (Optional)</label>
              <input type="text" class="form-input" [(ngModel)]="paymentForm.transactionId" name="transactionId">
            </div>
            <div class="form-group">
              <label class="form-label">Payment Reference (Optional)</label>
              <input type="text" class="form-input" [(ngModel)]="paymentForm.paymentReference" name="paymentReference">
            </div>
            <div class="form-group">
              <label class="form-label">Notes (Optional)</label>
              <textarea class="form-input" [(ngModel)]="paymentForm.notes" name="notes" rows="3"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="closeBillModal()">Cancel</button>
              <button type="submit" class="btn-primary">Mark as Paid</button>
            </div>
          </form>
        </div>

        <div *ngIf="bill.status === 'PAID'" class="success-message">
          <p>âœ… Bill has been paid. The booking is confirmed and ready for check-in.</p>
        </div>
      </div>
      <div *ngIf="!isLoadingBill && !bill" class="error-message">
        Bill not found. Please wait a moment and try again, or contact support.
      </div>
    </div>
  </div>
</div>

