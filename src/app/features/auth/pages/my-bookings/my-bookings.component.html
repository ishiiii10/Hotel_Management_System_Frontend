<header class="header">
  <div class="header-content">
    <div class="logo">BELLE VUE</div>
    <nav class="nav">
      <a routerLink="/" class="nav-item">Search Hotels</a>
      <div class="nav-item active">My Bookings</div>
      <a routerLink="/dashboard" class="nav-item">My Dashboard</a>
    </nav>
  </div>
</header>

<div class="container">
  <div class="page-header">
    <h1 class="page-title">My Bookings</h1>
  </div>

  <div class="tabs">
    <div class="tab" [class.active]="activeTab === 'all'" (click)="setTab('all')">All Bookings</div>
    <div class="tab" [class.active]="activeTab === 'upcoming'" (click)="setTab('upcoming')">Upcoming</div>
    <div class="tab" [class.active]="activeTab === 'cancelled'" (click)="setTab('cancelled')">Cancelled</div>
  </div>

  <div *ngIf="isLoading" class="loading-message">Loading bookings...</div>

  <div *ngIf="!isLoading && getFilteredBookings().length === 0" class="empty-state">
    <div class="empty-title">No Bookings Found</div>
    <div class="empty-text">You don't have any bookings in this category</div>
    <button class="empty-btn" routerLink="/">Search Hotels</button>
  </div>

  <div *ngIf="!isLoading && getFilteredBookings().length > 0">
    <div class="booking-card" *ngFor="let booking of getFilteredBookings()">
      <div class="booking-header">
        <div class="booking-id">Booking #{{ booking.id }}</div>
        <div class="booking-status" [ngClass]="getStatusClass(booking.status)">
          {{ booking.status }}
        </div>
      </div>
      <div class="booking-content">
        <div class="booking-details">
          <div class="detail-row">
            <div class="detail-label">Hotel</div>
            <div class="detail-value">Hotel ID: {{ booking.hotelId }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Room</div>
            <div class="detail-value">{{ booking.roomNumber }} - {{ booking.roomType }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Check In</div>
            <div class="detail-value">{{ formatDate(booking.checkInDate) }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Check Out</div>
            <div class="detail-value">{{ formatDate(booking.checkOutDate) }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Guests</div>
            <div class="detail-value">{{ booking.numberOfGuests }} {{ booking.numberOfGuests === 1 ? 'Guest' : 'Guests' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Total Amount</div>
            <div class="detail-value">{{ formatCurrency(booking.totalAmount) }}</div>
          </div>
        </div>
        <img *ngIf="getHotelImage(booking.hotelId)" [src]="getHotelImage(booking.hotelId)" [alt]="'Hotel ' + booking.hotelId" class="booking-image">
        <div *ngIf="!getHotelImage(booking.hotelId)" class="booking-image booking-image-placeholder">Hotel Image</div>
      </div>
      <div class="booking-actions">
        <button class="action-btn" type="button" (click)="viewBookingDetails(booking)">View Details</button>
        <button 
          class="action-btn btn-view-bill" 
          type="button"
          (click)="viewBill(booking.id)">
          View Bill
        </button>
        <button 
          class="action-btn btn-cancel" 
          *ngIf="booking.status === 'CONFIRMED' || booking.status === 'CREATED'"
          (click)="cancelBooking(booking)">
          Cancel Booking
        </button>
        <button 
          class="action-btn" 
          *ngIf="booking.status === 'CHECKED_IN' || booking.status === 'CHECKED_OUT'">
          View Invoice
        </button>
        <button 
          class="action-btn" 
          *ngIf="booking.status === 'CHECKED_OUT'">
          Leave Review
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Details Modal -->
<div class="modal-overlay" *ngIf="showBookingDetailsModal" (click)="closeBookingDetailsModal()">
  <div class="modal-content booking-details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Booking Details</h2>
      <button class="close-button" (click)="closeBookingDetailsModal()">X</button>
    </div>
    <div class="modal-body">
      <div *ngIf="isLoadingBookingDetails" class="loading-message">Loading booking details...</div>
      
      <div *ngIf="!isLoadingBookingDetails && selectedBooking">
        <!-- Booking Status -->
        <div class="details-section">
          <div class="section-header">
            <h3>Booking Information</h3>
            <div class="booking-status-badge" [ngClass]="getStatusClass(selectedBooking.status)">
              {{ selectedBooking.status }}
            </div>
          </div>
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-label">Booking ID</div>
              <div class="detail-value">#{{ selectedBooking.id }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Booking Date</div>
              <div class="detail-value">{{ formatDate(selectedBooking.createdAt || '') }}</div>
            </div>
            <div class="detail-item" *ngIf="selectedBooking.numberOfNights">
              <div class="detail-label">Number of Nights</div>
              <div class="detail-value">{{ selectedBooking.numberOfNights }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Total Amount</div>
              <div class="detail-value highlight">{{ formatCurrency(selectedBooking.totalAmount) }}</div>
            </div>
          </div>
        </div>

        <!-- Hotel Information -->
        <div class="details-section" *ngIf="selectedHotel">
          <h3>Hotel Information</h3>
          <div class="hotel-info">
            <div class="hotel-image-container" *ngIf="selectedHotel.imageUrl">
              <img [src]="selectedHotel.imageUrl" [alt]="selectedHotel.name" class="hotel-image-large">
            </div>
            <div class="hotel-details">
              <div class="detail-item">
                <div class="detail-label">Hotel Name</div>
                <div class="detail-value">{{ selectedHotel.name }}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Address</div>
                <div class="detail-value">{{ selectedHotel.address }}, {{ selectedHotel.city }}, {{ selectedHotel.country }}</div>
              </div>
              <div class="detail-item" *ngIf="selectedHotel.contactNumber">
                <div class="detail-label">Contact Number</div>
                <div class="detail-value">{{ selectedHotel.contactNumber }}</div>
              </div>
              <div class="detail-item" *ngIf="selectedHotel.category">
                <div class="detail-label">Category</div>
                <div class="detail-value">{{ selectedHotel.category }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Room Information -->
        <div class="details-section">
          <h3>Room Information</h3>
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-label">Room Number</div>
              <div class="detail-value">{{ selectedBooking.roomNumber || 'N/A' }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Room Type</div>
              <div class="detail-value">{{ selectedBooking.roomType }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Check-In Date</div>
              <div class="detail-value">{{ formatDate(selectedBooking.checkInDate) }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Check-Out Date</div>
              <div class="detail-value">{{ formatDate(selectedBooking.checkOutDate) }}</div>
            </div>
          </div>
        </div>

        <!-- Guest Information -->
        <div class="details-section">
          <h3>Guest Information</h3>
          <div class="details-grid">
            <div class="detail-item" *ngIf="selectedBooking.guestName">
              <div class="detail-label">Primary Guest Name</div>
              <div class="detail-value">{{ selectedBooking.guestName }}</div>
            </div>
            <div class="detail-item" *ngIf="selectedBooking.guestEmail">
              <div class="detail-label">Email</div>
              <div class="detail-value">{{ selectedBooking.guestEmail }}</div>
            </div>
            <div class="detail-item" *ngIf="selectedBooking.guestPhone">
              <div class="detail-label">Phone Number</div>
              <div class="detail-value">{{ selectedBooking.guestPhone }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Number of Guests</div>
              <div class="detail-value">{{ selectedBooking.numberOfGuests }}</div>
            </div>
          </div>
          
          <!-- Guest Details List -->
          <div *ngIf="selectedBooking.guestDetails" class="guest-details-list">
            <h4>All Guests</h4>
            <div class="guest-list">
              <div class="guest-entry" *ngFor="let guest of parseGuestDetails(selectedBooking.guestDetails); let i = index">
                <div class="guest-number">Guest {{ i + 1 }}</div>
                <div class="guest-info">
                  <div class="guest-name">{{ guest.name }}</div>
                  <div class="guest-age">Age: {{ guest.age }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Special Requests -->
        <div class="details-section" *ngIf="selectedBooking.specialRequests">
          <h3>Special Requests</h3>
          <div class="special-requests">
            {{ selectedBooking.specialRequests }}
          </div>
        </div>

        <!-- Booking Timeline -->
        <div class="details-section">
          <h3>Booking Timeline</h3>
          <div class="timeline">
            <div class="timeline-item" *ngIf="selectedBooking.createdAt">
              <div class="timeline-date">{{ formatDate(selectedBooking.createdAt) }}</div>
              <div class="timeline-event">Booking Created</div>
            </div>
            <div class="timeline-item" *ngIf="selectedBooking.checkedInAt">
              <div class="timeline-date">{{ formatDate(selectedBooking.checkedInAt) }}</div>
              <div class="timeline-event">Checked In</div>
            </div>
            <div class="timeline-item" *ngIf="selectedBooking.checkedOutAt">
              <div class="timeline-date">{{ formatDate(selectedBooking.checkedOutAt) }}</div>
              <div class="timeline-event">Checked Out</div>
            </div>
            <div class="timeline-item" *ngIf="selectedBooking.cancelledAt">
              <div class="timeline-date">{{ formatDate(selectedBooking.cancelledAt) }}</div>
              <div class="timeline-event">Cancelled</div>
              <div class="timeline-note" *ngIf="selectedBooking.cancellationReason">
                Reason: {{ selectedBooking.cancellationReason }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeBookingDetailsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Bill Modal -->
<div class="modal-overlay" *ngIf="showBillModal" (click)="closeBillModal()">
  <div class="modal-content bill-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Bill Details</h2>
      <button class="close-button" (click)="closeBillModal()">X</button>
    </div>
    <div class="modal-body">
      <div *ngIf="isLoadingBill" class="loading-message">Loading bill...</div>
      <div *ngIf="!isLoadingBill && selectedBill" class="bill-details">
        <div class="bill-header">
          <div class="bill-number">Bill #{{ selectedBill.billNumber }}</div>
          <div class="bill-status" [class.pending]="selectedBill.status === 'PENDING'" [class.paid]="selectedBill.status === 'PAID'">
            {{ selectedBill.status }}
          </div>
        </div>
        
        <div class="bill-info">
          <div class="info-row">
            <span class="info-label">Booking ID:</span>
            <span class="info-value">{{ selectedBill.bookingId }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Total Amount:</span>
            <span class="info-value">{{ formatCurrency(selectedBill.totalAmount) }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Generated At:</span>
            <span class="info-value">{{ selectedBill.generatedAt | date:'medium' }}</span>
          </div>
          <div class="info-row" *ngIf="selectedBill.paidAt">
            <span class="info-label">Paid At:</span>
            <span class="info-value">{{ selectedBill.paidAt | date:'medium' }}</span>
          </div>
        </div>

        <div *ngIf="selectedBill.status === 'PAID'" class="success-message">
          <p>âœ… Bill has been paid. The booking is confirmed.</p>
        </div>
      </div>
      <div *ngIf="!isLoadingBill && !selectedBill" class="error-message">
        Bill not found. Please wait a moment and try again, or contact support.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeBillModal()">Close</button>
    </div>
  </div>
</div>

